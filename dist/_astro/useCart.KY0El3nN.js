import{r as u}from"./index.DiEladB3.js";const O=/\b(?:19|20)\d{2}\b/,S=/^default title$/i;function d(t){return typeof t=="string"?t.trim():""}function v(t){const e=d(t);if(!e)return"";const n=e.match(O);return n?n[0]:""}function w(t){return d(t).toLowerCase()}function N(t){return t?.variants?.edges?.map(e=>e?.node).filter(Boolean)??[]}function A(t,e=[]){const n=Array.isArray(t?.selectedOptions)?t.selectedOptions:[];if(!n.length)return"";const i=e.map(w),c=n.find(l=>i.includes(w(l?.name)));return d(c?.value)}function m(t){const e=A(t,["vintage","year","harvest"]);if(e)return e;const n=v(t?.title);return n||v(t?.sku)}function V(t){const e=A(t,["size","format","bottle size"]);if(e)return e;const n=d(t?.title);if(!n||S.test(n))return"";const i=n.split("/").map(c=>c.trim()).filter(Boolean);return i.length>1?i[1]:""}function q(t){const e=N(t).map(m).filter(Boolean);return[...new Set(e)].sort((i,c)=>{const l=Number.parseInt(i,10),o=Number.parseInt(c,10);return Number.isFinite(l)&&Number.isFinite(o)?l-o:i.localeCompare(c,void 0,{numeric:!0,sensitivity:"base"})})}function R(t){const e=q(t);return e.length?e.length===1?`Vintage: ${e[0]}`:`Vintages: ${e.join(", ")}`:""}function L(t){const e=m(t),n=V(t);if(e&&n)return`${e} / ${n}`;if(e)return`Vintage ${e}`;if(n)return n;const i=d(t?.title);return!i||S.test(i)?"Standard":i}function P(t){const e=N(t);if(!e.length)return null;const n=e.filter(o=>o?.availableForSale),i=n.length?n:e,c=i.find(o=>{const g=`${d(V(o))} ${d(o?.title)}`.toLowerCase();return/750\s*ml|bottle/.test(g)});if(c)return c;const l=i.map(o=>({variant:o,year:Number.parseInt(m(o),10)})).filter(o=>Number.isFinite(o.year)).sort((o,g)=>g.year-o.year)[0];return l?.variant?l.variant:i[0]}const h="jnw-cart-v1",C=24,T="jnw-cart-sync",k=155;function E(t){if(!t)return[];try{const e=JSON.parse(t);return Array.isArray(e)?e.map(n=>({...n,variantTitle:typeof n?.variantTitle=="string"&&n.variantTitle.trim()?n.variantTitle.trim():"",vintage:typeof n?.vintage=="string"&&n.vintage.trim()?n.vintage.trim():"",price:k.toFixed(2),currencyCode:"ZAR"})):[]}catch{return[]}}function $(){const[t,e]=u.useState([]),[n,i]=u.useState("idle");u.useEffect(()=>{e(E(localStorage.getItem(h)))},[]),u.useEffect(()=>{localStorage.setItem(h,JSON.stringify(t)),window.dispatchEvent(new CustomEvent(T,{detail:t}))},[t]),u.useEffect(()=>{function a(r){r.key===h&&e(E(r.newValue))}function s(r){const y=Array.isArray(r.detail)?r.detail:[];e(p=>JSON.stringify(p)===JSON.stringify(y)?p:y)}return window.addEventListener("storage",a),window.addEventListener(T,s),()=>{window.removeEventListener("storage",a),window.removeEventListener(T,s)}},[]);const c=u.useCallback((a,s)=>{if(!a?.id)return;const r=L(a),y=m(a);e(p=>{const b=p.findIndex(f=>f.variantId===a.id);return b===-1?[...p,{variantId:a.id,qty:1,title:s.title,variantTitle:r,vintage:y,price:k.toFixed(2),currencyCode:"ZAR"}]:p.map((f,x)=>x===b?{...f,qty:Math.min(C,f.qty+1),variantTitle:f.variantTitle||r,vintage:f.vintage||y}:f)})},[]),l=u.useCallback(a=>{e(s=>s.map(r=>r.variantId===a?{...r,qty:Math.min(C,r.qty+1)}:r))},[]),o=u.useCallback(a=>{e(s=>s.map(r=>r.variantId===a?{...r,qty:Math.max(0,r.qty-1)}:r).filter(r=>r.qty>0))},[]),g=u.useCallback(async(a={})=>{if(t.length){i("loading");try{const s=await fetch("/api/checkout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lineItems:t,compliance:a?.compliance??{},addressCheck:a?.addressCheck??{}})}),r=await s.json();if(!s.ok)throw new Error(r.error||"Checkout failed");r.webUrl&&(window.location.href=r.webUrl)}catch(s){console.error(s),i("error"),alert("Checkout could not be started. Please try again.")}finally{i("idle")}}},[t]),I=t.reduce((a,s)=>a+s.qty,0);return{cart:t,totalItems:I,checkoutState:n,addToCart:c,increment:l,decrement:o,checkout:g}}export{R as a,L as f,m as g,P as p,$ as u};
